<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ivrit HaOr — LuminaNexus</title>
  <meta name="description" content="Ivrit HaOr — letter by letter: pronunciation, meaning, gematria, practice." />
  <link rel="stylesheet" href="/styles/main.css" />
  <style>
    /* Ivrit HaOr Explorer - self-contained UI (safe; scoped to this page) */
    .ih-wrap { padding-top: 18px; padding-bottom: 28px; }
    .ih-card { padding: 18px; }
    .ih-head { display:flex; gap:14px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; }
    .ih-title { margin: 0; }
    .ih-sub { margin: 6px 0 0; opacity:.9; }
    .ih-controls {
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items:center;
      margin-top: 14px;
    }
    @media (max-width: 900px){
      .ih-controls { grid-template-columns: 1fr; }
    }
    .ih-input, .ih-select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.22);
      color: inherit;
    }
    .ih-toggleRow { display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .ih-pillBtn {
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color: inherit;
      cursor: pointer;
      white-space: nowrap;
    }
    .ih-pillBtn.is-on {
      border-color: rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.14);
    }

    .ih-jumps { margin-top: 12px; display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    .ih-jumpLabel { opacity:.85; margin-right: 6px; }
    .ih-jump {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.20);
      color: inherit;
      cursor:pointer;
      display:grid;
      place-items:center;
      font-size: 12px;
      line-height: 1;
    }
    .ih-jump.is-active {
      border-color: rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.10);
    }

    .ih-grid {
      margin-top: 14px;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 1000px){
      .ih-grid { grid-template-columns: 1fr; }
    }

    .ih-list {
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      padding: 12px;
      max-height: 68vh;
      overflow:auto;
    }

    .ih-item {
      display:flex;
      gap: 10px;
      justify-content:space-between;
      align-items:center;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      margin-bottom: 8px;
    }
    .ih-item:hover { background: rgba(255,255,255,0.06); }
    .ih-item.is-selected { border-color: rgba(255,255,255,0.30); background: rgba(255,255,255,0.08); }

    .ih-left { display:flex; gap:10px; align-items:center; min-width:0; }
    .ih-glyph {
      width: 42px; height: 42px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      display:grid; place-items:center;
      font-size: 24px;
    }
    .ih-meta { min-width:0; }
    .ih-name { font-weight: 700; }
    .ih-mini { opacity:.85; font-size: 12px; margin-top: 2px; }

    .ih-star {
      width: 34px; height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.18);
      color: inherit;
      cursor:pointer;
      display:grid; place-items:center;
      flex: none;
    }
    .ih-star.is-on { background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.35); }

    .ih-detail {
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      padding: 16px;
      min-height: 320px;
    }

    .ih-detailTop { display:flex; gap: 14px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; }
    .ih-bigGlyph { font-size: 52px; line-height: 1; }
    .ih-detailTitle { margin: 0; }
    .ih-detailLine { margin-top: 6px; opacity:.92; }
    .ih-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px; }
    .ih-btn {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color: inherit;
      cursor:pointer;
      white-space:nowrap;
    }
    .ih-btn:disabled { opacity:.55; cursor:not-allowed; }
    .ih-panels { margin-top: 14px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .ih-panels { grid-template-columns: 1fr; } }
    .ih-panel {
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      padding: 12px;
    }
    .ih-panel h4 { margin:0 0 8px; }
    .ih-empty { opacity:.85; padding: 10px; }
    .hebrew { direction: rtl; }
  </style>
</head>

<body class="with-glow">
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="site-header">
    <div class="wrap header-row">
      <div class="brand">
        <div class="brand-mark">◈</div>
        <div class="brand-text">
          <div class="brand-title">LuminaNexus</div>
          <div class="brand-subtitle">Ivrit HaOr — letter by letter</div>
        </div>
      </div>

      <nav class="nav pill-nav" aria-label="Primary">
        <a class="pill" href="/index.html">The Gate</a>
        <a class="pill" href="/pages/torah-first.html">Torah First</a>
        <a class="pill" href="/pages/seven-laws.html">The Seven Laws</a>
        <a class="pill" href="/pages/study-paths.html">Study Paths</a>
        <a class="pill" href="/pages/chavruta.html">Chavruta</a>
        <a class="pill" href="/pages/trees.html">The Trees</a>
        <a class="pill" href="/pages/library.html">The Library</a>
        <a class="pill active" href="/pages/ivrit-haor.html">Ivrit HaOr</a>
        <a class="pill" href="/pages/about.html">About</a>
        <a class="pill" href="/pages/blessing.html">Blessing</a>
      </nav>
    </div>
  </header>

  <main id="main">
    <section class="wrap ih-wrap">
      <article class="card ih-card">
        <div class="card-tag">MODULE · <span class="hebrew-inline">מודול</span></div>

        <div class="ih-head">
          <div>
            <h2 class="ih-title">Ivrit HaOr Explorer</h2>
            <p class="ih-sub">
              English + Hebrew. Pronunciation, meaning, gematria, practice — one letter at a time.
              <span class="hebrew-inline">עברית האור — אות אחר אות.</span>
            </p>
          </div>
          <div class="ih-toggleRow">
            <button id="btnFavFilter" class="ih-pillBtn" type="button" aria-pressed="false">★ Favorites</button>
            <button id="btnSendToChavruta" class="ih-pillBtn" type="button" disabled>Send to Chavruta</button>
          </div>
        </div>

        <div class="ih-controls">
          <input id="q" class="ih-input" type="text" placeholder="Search letter or name… (e.g., Aleph, גימל, Tav, אריר)" />
          <select id="typeFilter" class="ih-select" aria-label="Filter type">
            <option value="all">All</option>
            <option value="letter">Letters</option>
            <option value="final">Final forms</option>
            <option value="gate">Gates</option>
            <option value="name">Names</option>
          </select>
          <label style="display:flex; gap:10px; align-items:center; justify-content:flex-end;">
            <input id="showHebrew" type="checkbox" checked />
            Show Hebrew
          </label>
        </div>

        <div class="ih-jumps" aria-label="Quick jump">
          <span class="ih-jumpLabel">A–Z</span>
          <div id="jumpAZ" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
        </div>

        <div class="ih-jumps" aria-label="Quick jump Hebrew">
          <span class="ih-jumpLabel">א–ת</span>
          <div id="jumpHeb" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
        </div>

        <div class="ih-grid">
          <div class="ih-list" aria-label="Letter list">
            <div id="list"></div>
          </div>

          <div class="ih-detail" aria-label="Details">
            <div id="detailEmpty" class="ih-empty">
              Select a letter to begin. <span class="hebrew-inline">בחר/י אות להתחלה.</span>
            </div>
            <div id="detail" style="display:none;"></div>
          </div>
        </div>

        <p class="hero-note" style="margin: 14px 0 0;">
          Tip: Favorites are saved on this device (localStorage).
          <span class="hebrew-inline">מועדפים נשמרים במכשיר זה.</span>
        </p>
      </article>
    </section>
  </main>

  <footer class="site-footer">
    <div class="wrap">
      <p>© LuminaNexus — offered freely for learning.</p>
      <p>Torah First: peshat before abstraction, tradition before novelty, learning as service — with clear boundaries and gentle dignity.</p>
    </div>
  </footer>

  <script src="/scripts/nav-active.js" defer></script>

  <script>
    (() => {
      // ----------------------------
      // Data (self-contained)
      // ----------------------------
      const items = [
        // 22 letters
        { id:"alef", type:"letter", latin:"Aleph", heb:"א", translit:"’alef", sound:"silent / glottal stop", gem:1, meaning:"Oneness, origin, breath-before-speech.", practice:"Breathe in silence for 3 breaths; then speak one honest sentence." },
        { id:"bet", type:"letter", latin:"Bet", heb:"ב", translit:"bet", sound:"b / v (with dagesh/without)", gem:2, meaning:"House, container, blessing-in-form.", practice:"Name one ‘house’ you keep: a habit, a room, a vow. Guard it today." },
        { id:"gimel", type:"letter", latin:"Gimel", heb:"ג", translit:"gimel", sound:"g", gem:3, meaning:"Bridge, giving, motion toward.", practice:"Do one quiet act of giving with no announcement." },
        { id:"dalet", type:"letter", latin:"Dalet", heb:"ד", translit:"dalet", sound:"d", gem:4, meaning:"Doorway, threshold, humility.", practice:"Pause at one doorway today and set intention before entering." },
        { id:"he", type:"letter", latin:"He", heb:"ה", translit:"he", sound:"h", gem:5, meaning:"Breath, revelation, gentle opening.", practice:"Exhale slowly; let the last bit of breath ‘say’ a prayer." },
        { id:"vav", type:"letter", latin:"Vav", heb:"ו", translit:"vav", sound:"v / w (varies)", gem:6, meaning:"Hook, connection, ‘and’.", practice:"Link two good things: gratitude + action. Do the action." },
        { id:"zayin", type:"letter", latin:"Zayin", heb:"ז", translit:"zayin", sound:"z", gem:7, meaning:"Completion, protection, holy restraint.", practice:"Choose one small restraint that protects your peace." },
        { id:"chet", type:"letter", latin:"Chet", heb:"ח", translit:"chet", sound:"kh (guttural)", gem:8, meaning:"Life-force, inner courtyard.", practice:"Place a hand on heart; whisper ‘chayim’ once." },
        { id:"tet", type:"letter", latin:"Tet", heb:"ט", translit:"tet", sound:"t", gem:9, meaning:"Hidden good, inward spiral.", practice:"Find one hidden good in something annoying. Name it." },
        { id:"yod", type:"letter", latin:"Yod", heb:"י", translit:"yod", sound:"y", gem:10, meaning:"Point, seed, the small that holds the vast.", practice:"Take one tiny step toward a long promise." },
        { id:"kaf", type:"letter", latin:"Kaf", heb:"כ", translit:"kaf", sound:"k / kh", gem:20, meaning:"Palm, capacity, blessing held.", practice:"Open your palm: receive help once; give help once." },
        { id:"lamed", type:"letter", latin:"Lamed", heb:"ל", translit:"lamed", sound:"l", gem:30, meaning:"Learning, longing upward.", practice:"Study 5 minutes; write one line you truly learned." },
        { id:"mem", type:"letter", latin:"Mem", heb:"מ", translit:"mem", sound:"m", gem:40, meaning:"Water, flow, womb of understanding.", practice:"Drink water slowly; let it be a blessing." },
        { id:"nun", type:"letter", latin:"Nun", heb:"נ", translit:"nun", sound:"n", gem:50, meaning:"Faithfulness, falling-and-rising.", practice:"If you stumble today, stand gently and continue." },
        { id:"samekh", type:"letter", latin:"Samekh", heb:"ס", translit:"samekh", sound:"s", gem:60, meaning:"Support, circle, upheld life.", practice:"Support one person (or yourself) in one practical way." },
        { id:"ayin", type:"letter", latin:"Ayin", heb:"ע", translit:"ayin", sound:"‘ (guttural, often silent)", gem:70, meaning:"Eye, perception, inner seeing.", practice:"Look at one thing and describe it without judgment." },
        { id:"pe", type:"letter", latin:"Pe", heb:"פ", translit:"pe", sound:"p / f", gem:80, meaning:"Mouth, speech, creative breath.", practice:"Speak one word less—listen one breath more." },
        { id:"tsadi", type:"letter", latin:"Tsadi", heb:"צ", translit:"tsadi", sound:"ts", gem:90, meaning:"Righteous alignment, straightness-with-bend.", practice:"Choose the right thing in one small decision." },
        { id:"qof", type:"letter", latin:"Qof", heb:"ק", translit:"qof", sound:"k (deeper)", gem:100, meaning:"Holy edge, the near-and-far.", practice:"Approach holiness through one ordinary act done carefully." },
        { id:"resh", type:"letter", latin:"Resh", heb:"ר", translit:"resh", sound:"r", gem:200, meaning:"Head, beginning again, poor-in-spirit.", practice:"Begin again: restart one good habit today." },
        { id:"shin", type:"letter", latin:"Shin", heb:"ש", translit:"shin", sound:"sh / s (sin)", gem:300, meaning:"Fire, transformation, threefold flame.", practice:"Warm one relationship with one sincere line." },
        { id:"tav", type:"letter", latin:"Tav", heb:"ת", translit:"tav", sound:"t", gem:400, meaning:"Seal, covenant, completion.", practice:"Finish one small thing you’ve been delaying." },

        // final forms
        { id:"kaf-final", type:"final", latin:"Final Kaf", heb:"ך", translit:"kaf sofit", sound:"k / kh", gem:20, meaning:"The held blessing at the end of a word.", practice:"Close one loop: reply, return, repair." },
        { id:"mem-final", type:"final", latin:"Final Mem", heb:"ם", translit:"mem sofit", sound:"m", gem:40, meaning:"Sealed waters; hidden completion.", practice:"Keep one sacred thing private today." },
        { id:"nun-final", type:"final", latin:"Final Nun", heb:"ן", translit:"nun sofit", sound:"n", gem:50, meaning:"Extended faith; endurance.", practice:"Stay steady for 60 seconds in silence." },
        { id:"pe-final", type:"final", latin:"Final Pe", heb:"ף", translit:"pe sofit", sound:"p / f", gem:80, meaning:"Speech that concludes cleanly.", practice:"End one conversation kindly." },
        { id:"tsadi-final", type:"final", latin:"Final Tsadi", heb:"ץ", translit:"tsadi sofit", sound:"ts", gem:90, meaning:"Righteousness at the edge.", practice:"Let the ‘last word’ be peace." },

        // gates / special
        { id:"alef-olam", type:"gate", latin:"Alef Olam", heb:"אלף עולם", translit:"alef olam", sound:"ah-LEF oh-LAHM", gem:null, meaning:"Hidden Gate — the Alef of Worlds. A unified origin behind letters.", practice:"Sit 26 seconds. Imagine a single point becoming all letters." },

        // names
        { id:"ariir", type:"name", latin:"Ari’ir", heb:"אריר", translit:"ari’ir", sound:"ah-REE-eer", gem:null, meaning:"Sacred name (meditation). Use with humility and clean intention.", practice:"Chant softly 7 times; then sit in quiet for 20 seconds." },
      ];

      // ----------------------------
      // State + storage
      // ----------------------------
      const $ = (id) => document.getElementById(id);
      const els = {
        q: $("q"),
        typeFilter: $("typeFilter"),
        showHebrew: $("showHebrew"),
        list: $("list"),
        detail: $("detail"),
        detailEmpty: $("detailEmpty"),
        btnFavFilter: $("btnFavFilter"),
        btnSendToChavruta: $("btnSendToChavruta"),
        jumpAZ: $("jumpAZ"),
        jumpHeb: $("jumpHeb"),
      };

      const STORAGE_KEY = "ivritHaorFavorites.v1";
      const state = {
        selectedId: null,
        favOnly: false,
        favs: new Set(),
        activeJumpAZ: "",
        activeJumpHeb: "",
      };

      function loadFavs() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)) state.favs = new Set(arr);
        } catch (e) {}
      }
      function saveFavs() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify([...state.favs]));
        } catch (e) {}
      }

      // ----------------------------
      // Helpers
      // ----------------------------
      function normalize(s){ return (s || "").toLowerCase().trim(); }

      function matchesQuery(item, q) {
        if (!q) return true;
        const n = normalize(q);
        const hay = [
          item.latin, item.heb, item.translit, item.type,
          (item.meaning || ""), (item.practice || ""), (item.sound || "")
        ].join(" ");
        return normalize(hay).includes(n);
      }

      function matchesType(item, type) {
        return type === "all" ? true : item.type === type;
      }

      function matchesJump(item) {
        if (state.activeJumpAZ) {
          const first = (item.latin || "").charAt(0).toUpperCase();
          if (first !== state.activeJumpAZ) return false;
        }
        if (state.activeJumpHeb) {
          // Hebrew jump: match first Hebrew character (for Alef Olam we match א by its first letter א in phrase)
          const firstHeb = (item.heb || "").trim().charAt(0);
          if (firstHeb !== state.activeJumpHeb) return false;
        }
        return true;
      }

      function filteredItems() {
        const q = els.q.value.trim();
        const type = els.typeFilter.value;
        return items.filter(it => {
          if (state.favOnly && !state.favs.has(it.id)) return false;
          return matchesType(it, type) && matchesQuery(it, q) && matchesJump(it);
        });
      }

      function setSelected(id) {
        state.selectedId = id;
        renderList();
        renderDetail();
        els.btnSendToChavruta.disabled = !id;
      }

      function toggleFav(id) {
        if (state.favs.has(id)) state.favs.delete(id);
        else state.favs.add(id);
        saveFavs();
        renderList();
        renderDetail();
        // If user is in favOnly mode and removed last favorite, list could go empty — that’s ok.
      }

      function speak(text) {
        if (!("speechSynthesis" in window)) return alert("Speech synthesis not supported in this browser.");
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.92;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }

      function copyText(text) {
        navigator.clipboard?.writeText(text).catch(() => {});
      }

      function buildChavrutaPrompt(item) {
        // English + Hebrew
        const lines = [
          `Ivrit HaOr — ${item.latin}${item.heb ? " (" + item.heb + ")" : ""}`,
          item.translit ? `Transliteration: ${item.translit}` : null,
          item.sound ? `Sound: ${item.sound}` : null,
          (item.gem || item.gem === 0) ? `Gematria: ${item.gem}` : null,
          "",
          "Meaning:",
          item.meaning || "",
          "",
          "Practice:",
          item.practice || "",
          "",
          "Chavruta question:",
          "Can you give peshat + one classical note, then 2–4 honest questions about this?"
        ].filter(Boolean);
        return lines.join("\n");
      }

      function sendToChavruta() {
        const item = items.find(x => x.id === state.selectedId);
        if (!item) return;

        const payload = buildChavrutaPrompt(item);

        // Best effort: pass via querystring AND sessionStorage
        try { sessionStorage.setItem("chavrutaPrefill", payload); } catch (e) {}

        const url = "/pages/chavruta.html?prefill=" + encodeURIComponent(payload);
        window.open(url, "_blank", "noopener,noreferrer");
      }

      // ----------------------------
      // Render
      // ----------------------------
      function renderJumps() {
        // A–Z
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        els.jumpAZ.innerHTML = letters.map(ch => {
          const on = state.activeJumpAZ === ch ? "is-active" : "";
          return `<button class="ih-jump ${on}" type="button" data-jump-az="${ch}" title="Jump ${ch}">${ch}</button>`;
        }).join("");

        // א–ת (including finals as separate? We'll keep main 22 here)
        const heb = ["א","ב","ג","ד","ה","ו","ז","ח","ט","י","כ","ל","מ","נ","ס","ע","פ","צ","ק","ר","ש","ת"];
        els.jumpHeb.innerHTML = heb.map(ch => {
          const on = state.activeJumpHeb === ch ? "is-active" : "";
          return `<button class="ih-jump hebrew ${on}" type="button" data-jump-heb="${ch}" title="Jump ${ch}">${ch}</button>`;
        }).join("");
      }

      function renderList() {
        const list = filteredItems();
        if (!list.length) {
          const msg = state.favOnly
            ? "No favorites yet. Click ★ on a letter to save it."
            : "No results.";
          els.list.innerHTML = `<div class="ih-empty">${msg}</div>`;
          return;
        }

        const showHeb = els.showHebrew.checked;
        els.list.innerHTML = list.map(it => {
          const selected = it.id === state.selectedId ? "is-selected" : "";
          const isFav = state.favs.has(it.id) ? "is-on" : "";
          const glyph = showHeb ? (it.heb || "•") : (it.latin?.charAt(0) || "•");
          const mini = [
            it.type ? it.type : "",
            (it.gem || it.gem === 0) ? ("Gematria: " + it.gem) : ""
          ].filter(Boolean).join(" · ");

          return `
            <div class="ih-item ${selected}" data-pick="${it.id}">
              <div class="ih-left">
                <div class="ih-glyph ${showHeb ? "hebrew" : ""}">${glyph}</div>
                <div class="ih-meta">
                  <div class="ih-name">${it.latin}</div>
                  <div class="ih-mini">${showHeb && it.heb ? `<span class="hebrew">${it.heb}</span> · ` : ""}${mini}</div>
                </div>
              </div>
              <button class="ih-star ${isFav}" type="button" data-fav="${it.id}" aria-label="Favorite ${it.latin}">★</button>
            </div>
          `;
        }).join("");
      }

      function renderDetail() {
        const it = items.find(x => x.id === state.selectedId);
        if (!it) {
          els.detail.style.display = "none";
          els.detailEmpty.style.display = "block";
          els.btnSendToChavruta.disabled = true;
          return;
        }

        const isFav = state.favs.has(it.id) ? "is-on" : "";
        const showHeb = els.showHebrew.checked;

        els.detail.innerHTML = `
          <div class="ih-detailTop">
            <div>
              <div class="ih-bigGlyph ${showHeb ? "hebrew" : ""}">${showHeb ? (it.heb || "•") : (it.latin || "•")}</div>
              <h3 class="ih-detailTitle">${it.latin}</h3>
              <div class="ih-detailLine">
                ${showHeb && it.heb ? `<span class="hebrew">${it.heb}</span> · ` : ""}
                <span>Type: ${it.type}</span>
                ${ (it.gem || it.gem === 0) ? ` · <span>Gematria: ${it.gem}</span>` : "" }
              </div>
              ${it.sound ? `<div class="ih-detailLine">Sound: ${it.sound}</div>` : ""}
              ${it.translit ? `<div class="ih-detailLine">Transliteration: ${it.translit}</div>` : ""}
              <div class="ih-actions">
                <button class="ih-btn" type="button" id="btnSpeak">Play pronunciation</button>
                <button class="ih-btn" type="button" id="btnCopy">Copy</button>
                <button class="ih-btn" type="button" id="btnSend">Send to Chavruta</button>
                <button class="ih-btn ${isFav}" type="button" id="btnFav">${state.favs.has(it.id) ? "★ Favorited" : "☆ Favorite"}</button>
              </div>
            </div>
          </div>

          <div class="ih-panels">
            <div class="ih-panel">
              <h4>Meaning</h4>
              <div>${it.meaning || ""}</div>
            </div>
            <div class="ih-panel">
              <h4>Practice</h4>
              <div>${it.practice || ""}</div>
            </div>
          </div>
        `;

        els.detail.style.display = "block";
        els.detailEmpty.style.display = "none";
        els.btnSendToChavruta.disabled = false;

        // Wire detail buttons
        const speakText = (it.latin + (it.translit ? (", " + it.translit) : "") + (showHeb && it.heb ? (", " + it.heb) : "")).trim();
        $("btnSpeak").addEventListener("click", () => speak(speakText));
        $("btnCopy").addEventListener("click", () => copyText(buildChavrutaPrompt(it)));
        $("btnSend").addEventListener("click", sendToChavruta);
        $("btnFav").addEventListener("click", () => toggleFav(it.id));
      }

      function renderAll() {
        renderJumps();
        renderList();
        renderDetail();
      }

      // ----------------------------
      // Events
      // ----------------------------
      function clearJumps(which) {
        if (which === "az") state.activeJumpAZ = "";
        if (which === "heb") state.activeJumpHeb = "";
      }

      document.addEventListener("click", (e) => {
        const pick = e.target.closest("[data-pick]")?.getAttribute("data-pick");
        if (pick) return setSelected(pick);

        const fav = e.target.closest("[data-fav]")?.getAttribute("data-fav");
        if (fav) return toggleFav(fav);

        const jAZ = e.target.closest("[data-jump-az]")?.getAttribute("data-jump-az");
        if (jAZ) {
          state.activeJumpAZ = (state.activeJumpAZ === jAZ) ? "" : jAZ;
          // don't force-clear Hebrew jump; user may combine if they want
          renderAll();
          return;
        }

        const jH = e.target.closest("[data-jump-heb]")?.getAttribute("data-jump-heb");
        if (jH) {
          state.activeJumpHeb = (state.activeJumpHeb === jH) ? "" : jH;
          renderAll();
          return;
        }
      });

      els.q.addEventListener("input", () => renderAll());
      els.typeFilter.addEventListener("change", () => renderAll());
      els.showHebrew.addEventListener("change", () => renderAll());

      els.btnFavFilter.addEventListener("click", () => {
        state.favOnly = !state.favOnly;
        els.btnFavFilter.classList.toggle("is-on", state.favOnly);
        els.btnFavFilter.setAttribute("aria-pressed", String(state.favOnly));
        renderAll();
      });

      els.btnSendToChavruta.addEventListener("click", sendToChavruta);

      // ----------------------------
      // Boot
      // ----------------------------
      loadFavs();
      renderAll();

      // Select Aleph by default
      setSelected("alef");
    })();
  </script>
</body>
</html>
