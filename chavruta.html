<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chavruta â€” Lumina Nexus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Chavruta is the study trunk of LuminaNexus â€” slow questions, honest learning, and guided journeys for Shabbat, prayer, middot, and the Seven Laws."
    />

    <!-- Shared site styles -->
    <link rel="stylesheet" href="/assets/css/main.css" />
    <!-- Page-specific styles -->
    <link rel="stylesheet" href="/assets/css/chavruta.css" />
  </head>
  <body class="page chavruta-page">
    <!-- Top navigation -->
    <header class="nav-shell">
      <div class="nav-inner">
        <a href="/" class="brand">
          <span class="brand-title">LUMINA NEXUS</span>
          <span class="brand-subtitle">Sanctuary Â· Study Â· Build</span>
        </a>

        <nav class="nav-links-desktop">
          <a href="/about/">About</a>
          <a href="/chavruta" aria-current="page">Chavruta</a>
          <a href="/library/">Library</a>
          <a href="/map/">Map</a>
          <a href="/seal/">Seal</a>
          <a href="/support/">Support</a>
          <a href="/chavruta" class="nav-cta">
            <span>Enter Sanctuary</span>
            <span>â†’</span>
          </a>
        </nav>

        <button class="nav-toggle" type="button" aria-label="Toggle navigation">
          <span class="nav-toggle-bar"></span>
          <span class="nav-toggle-bar"></span>
        </button>
      </div>

      <nav class="nav-links-mobile" id="mobileNav">
        <a href="/about/">About</a>
        <a href="/chavruta" aria-current="page">Chavruta</a>
        <a href="/library/">Library</a>
        <a href="/map/">Map</a>
        <a href="/seal/">Seal</a>
        <a href="/support/">Support</a>
        <a href="/chavruta" class="nav-cta-mobile">
          <span>Enter Sanctuary</span>
          <span>â†’</span>
        </a>
      </nav>
    </header>

    <main>
      <!-- Top banner -->
      <section class="chav-hero-shell">
        <div class="chav-hero-card">
          <div class="chav-pill-row">
            <span class="chav-pill-main">Chavruta Â· ×—Ö²×‘Ö°×¨×•Ö¼×ªÖ¸×</span>
            <span class="chav-pill-tag">Study in good company</span>
          </div>

          <h1 class="chav-hero-title">Study in good company.</h1>

          <p class="chav-hero-subtitle">
            This is the study trunk of LuminaNexus. Here the pace is slow, the questions
            are honest, and the goal is not hot takes but clarified life.
          </p>

          <p class="chav-hero-line">
            ×›Ö¸Ö¼××Ÿ ×§×•Ö¹×“Ö°×Ö´×™× ×œÖ¹× ×Ö·×” ×©Ö¶××¢×•Ö¹× Ö´×™× ×¦Ö¸×¨Ö´×™×šÖ° ×œÖ·×¢Ö²× ×•Ö¹×ª, ×Ö¶×œÖ¸Ö¼× ×Ö¸×” ×©Ö¶××œÖ´Ö¼×‘Ö°Ö¼×šÖ¸ ×¨×•Ö¹×¦Ö¶×” ×œÖ´×œÖ°×Ö¹×“.
          </p>

          <div class="chav-hero-ctas">
            <a href="/" class="btn-primary btn-small">
              â† Back to the Sanctuary
            </a>
            <a href="#ask" class="btn-ghost btn-small">
              <span>ğŸª‘</span>
              <span>Sit at the table</span>
            </a>
            <a href="#sessions" class="chav-link-inline">View study paths âŸ¶</a>
          </div>
        </div>
      </section>

      <!-- Main layout: ask + sessions side by side -->
      <section class="chav-main-shell">
        <div class="chav-grid">
          <!-- ASK / CHAT CARD -->
          <article class="chav-card chav-ask" id="ask">
            <header class="chav-card-header">
              <p class="chav-eyebrow">Your side of the table</p>
              <h2>Bring one question.</h2>
            </header>

            <p class="chav-body">
              Write it slowly, as if you were speaking to a friend across the table.
              ChavrutaGPT will answer with sources and care.
            </p>

            <form id="chat-form" class="chav-form">
              <label class="chav-label" for="chat-input">
                Your question
              </label>

              <textarea
                id="chat-input"
                name="question"
                class="chav-textarea"
                placeholder="For example:
â€¢ What does Rashi see in Bereshit 1:1 that I keep missing?
â€¢ How do I balance kavod and anavah with my family?
â€¢ What does it mean to keep Shabbat in my situation?"
              ></textarea>

              <button class="btn-primary chav-ask-button" type="submit">
                <span>Ask your chavruta</span>
                <span class="chav-ask-icon">â†µ</span>
              </button>
              <p class="chav-help-text">
                Press <strong>Enter</strong> to send Â·
                <strong>Shift + Enter</strong> for a new line.
              </p>
            </form>

            <!-- Conversation log -->
            <div class="chav-log-shell">
              <p class="chav-log-label">Conversation</p>
              <div id="chat-log" class="chav-log" aria-live="polite"></div>
            </div>
          </article>

          <!-- SESSIONS CARD -->
          <section
            class="chav-card chav-sessions"
            id="sessions"
            aria-label="Study sessions"
          >
            <header class="chav-card-header">
              <p class="chav-eyebrow">Your chavruta willâ€¦</p>
              <h2>Choose a session.</h2>
            </header>

            <p class="chav-body">
              Each session has a different pace. All of them share the same kavod: honest
              questions, gentle answers, and sources you can open yourself.
            </p>

            <div class="chav-session-grid">
              <a class="chav-session" href="/chavruta/slow-series/">
                <div class="chav-session-icon">ğŸ“–</div>
                <div class="chav-session-body">
                  <h3>Slow Series</h3>
                  <p>
                    Multi-week, text-centered learning with one core sugya. Expect
                    sources, questions, and one practice to carry into the week.
                  </p>
                  <p class="chav-session-meta">
                    Best for: deep dives, chavruta notes.
                  </p>
                </div>
              </a>

              <a class="chav-session" href="/chavruta/table-question/">
                <div class="chav-session-icon">ğŸ•¯ï¸</div>
                <div class="chav-session-body">
                  <h3>Table Question</h3>
                  <p>
                    One focused question, one sitting. A clear answer, a few sources, and
                    a small next step â€“ no rush, no pressure.
                  </p>
                  <p class="chav-session-meta">
                    Best for: â€œthis is on my heart today.â€
                  </p>
                </div>
              </a>

              <a class="chav-session" href="/chavruta/walking-companion/">
                <div class="chav-session-icon">ğŸš¶â€â™‚ï¸</div>
                <div class="chav-session-body">
                  <h3>Walking Companion</h3>
                  <p>
                    Ongoing, lighter touch. Bring the weekâ€™s moments; your chavruta helps
                    you weave them into Torah and practice.
                  </p>
                  <p class="chav-session-meta">
                    Best for: gentle, continuous chavruta.
                  </p>
                </div>
              </a>
            </div>
          </section>
        </div>
      </section>
    </main>

    <footer>
      <div class="footer-inner">
        <span>Â© 2026 LuminaNexus. A quiet nexus for luminous work.</span>
        <div class="footer-right">
          <span>Crafted with kavod in the digital night.</span>
        </div>
      </div>
    </footer>

    <!-- Inline JS: nav toggle + ChavrutaGPT wiring -->
    <script>
      (function () {
        // --- nav toggle ---
        const toggle = document.querySelector(".nav-toggle");
        const mobileNav = document.getElementById("mobileNav");
        if (toggle && mobileNav) {
          toggle.addEventListener("click", () => {
            mobileNav.classList.toggle("is-open");
          });
        }

        // --- chavruta chat wiring ---
        const form = document.getElementById("chat-form");
        const input = document.getElementById("chat-input");
        const log = document.getElementById("chat-log");
        if (!form || !input || !log) return;

        let conversation = [];

        function addMessage(role, content) {
          const wrapper = document.createElement("div");
          wrapper.classList.add("chat-message", role);

          const meta = document.createElement("div");
          meta.classList.add("chat-meta");
          const label =
            role === "user"
              ? "You"
              : role === "assistant"
              ? "ChavrutaGPT"
              : "System";
          const time = new Date();
          const timeStr = time.toLocaleTimeString([], {
            hour: "numeric",
            minute: "2-digit",
          });
          meta.textContent = label + " Â· " + timeStr;

          const body = document.createElement("div");
          body.classList.add("chat-text");
          body.textContent = content;

          wrapper.appendChild(meta);
          wrapper.appendChild(body);
          log.appendChild(wrapper);
          log.scrollTop = log.scrollHeight;
        }

        // Enter submits, Shift+Enter = new line
        input.addEventListener("keydown", (event) => {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            form.requestSubmit();
          }
        });

        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          const text = input.value.trim();
          if (!text) return;

          addMessage("user", text);
          conversation.push({ role: "user", content: text });
          input.value = "";
          input.focus();

          const thinking = document.createElement("div");
          thinking.classList.add("chat-message", "system");
          const thinkingMeta = document.createElement("div");
          thinkingMeta.classList.add("chat-meta");
          thinkingMeta.textContent = "ChavrutaGPT Â· â€¦";
          const thinkingBody = document.createElement("div");
          thinkingBody.classList.add("chat-text");
          thinkingBody.textContent = "Thinkingâ€¦";
          thinking.appendChild(thinkingMeta);
          thinking.appendChild(thinkingBody);

          log.appendChild(thinking);
          log.scrollTop = log.scrollHeight;

          try {
            const res = await fetch("/.netlify/functions/chavruta-gpt", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ messages: conversation }),
            });

            const data = await res.json();
            console.log("Chavruta response:", data);
            log.removeChild(thinking);

            let replyText = "";

            if (data) {
              if (typeof data.reply === "string") {
                replyText = data.reply;
              } else if (data.reply && typeof data.reply === "object") {
                replyText =
                  data.reply.content ||
                  data.reply.message ||
                  data.reply.text ||
                  "";
              } else if (Array.isArray(data.choices)) {
                const first = data.choices[0];
                if (first && first.message && first.message.content) {
                  replyText = first.message.content;
                }
              } else if (typeof data === "string") {
                replyText = data;
              } else if (data.content || data.message || data.text) {
                replyText =
                  data.content || data.message || data.text || "";
              }
            }

            if (!replyText) {
              replyText =
                "Iâ€™m here with you, but I couldnâ€™t understand the response from the server.";
            }

            addMessage("assistant", replyText);
            conversation.push({ role: "assistant", content: replyText });
          } catch (err) {
            console.error(err);
            log.removeChild(thinking);
            addMessage(
              "system",
              "Sorry, there was an error talking to your chavruta. Please try again in a moment."
            );
          }
        });
      })();
    </script>
  </body>
</html>
