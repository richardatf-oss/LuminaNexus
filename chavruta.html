<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chavruta — LuminaNexus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Chavruta is the study trunk of LuminaNexus — slow questions, honest learning, and guided journeys."
  />
  <link rel="stylesheet" href="/assets/css/global.css" />

  <style>
    .ch-page {
      padding-bottom: 3rem;
    }

    .ch-wrap {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* Table card */
    .ch-table {
      margin-top: 2.25rem;
      margin-bottom: 2.25rem;
      padding: 2rem 2.25rem;
      border-radius: 28px;
      background:
        radial-gradient(circle at top left, rgba(255,255,255,0.07), transparent 55%),
        rgba(4, 10, 26, 0.96);
      box-shadow:
        0 22px 52px rgba(0, 0, 0, 0.78),
        0 0 0 1px rgba(255,255,255,0.03);
      box-sizing: border-box;
    }

    .ch-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.35fr) minmax(0, 1fr);
      gap: 1.75rem;
      align-items: start;
    }

    .ch-kicker {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.07);
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.9;
      margin-bottom: 0.8rem;
    }

    .ch-h2 {
      margin: 0 0 0.5rem 0;
      font-size: clamp(1.4rem, 2.6vw, 1.85rem);
      line-height: 1.15;
    }

    .ch-sub {
      margin: 0 0 1.25rem 0;
      opacity: 0.88;
      line-height: 1.6;
      max-width: 44rem;
    }

    .ch-form {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .ch-label {
      font-size: 0.95rem;
      font-weight: 500;
      opacity: 0.95;
    }

    .ch-textarea {
      width: 100%;
      min-height: 190px;
      resize: vertical;
      padding: 0.95rem 1rem;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(3, 7, 20, 0.98);
      color: #f8f8ff;
      font: inherit;
      line-height: 1.6;
      box-sizing: border-box;
    }

    .ch-textarea::placeholder {
      color: rgba(255, 255, 255, 0.42);
    }

    .ch-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 0.25rem;
    }

    .ch-meta {
      font-size: 0.85rem;
      opacity: 0.75;
      line-height: 1.5;
      max-width: 44rem;
    }

    .ch-side {
      padding-top: 0.25rem;
    }

    .ch-side-title {
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.9;
      margin: 0 0 0.6rem 0;
    }

    .ch-side ul {
      margin: 0.35rem 0 0 1.1rem;
      padding: 0;
      line-height: 1.7;
      opacity: 0.88;
      font-size: 0.95rem;
    }

    .ch-side li { margin-bottom: 0.35rem; }

    .ch-status {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      opacity: 0.85;
      display: none;
    }

    /* Sessions strip */
    .ch-sessions {
      margin-top: 1.5rem;
    }

    @media (max-width: 900px) {
      .ch-table { padding: 1.5rem 1.25rem; border-radius: 22px; }
      .ch-grid { grid-template-columns: 1fr; }
      .ch-row { justify-content: flex-start; }
      .ch-textarea { min-height: 170px; }
    }

    @media (max-width: 420px) {
      .ch-table { padding: 1.2rem 1rem; border-radius: 18px; }
      .ch-textarea { min-height: 160px; padding: 0.85rem 0.85rem; }
    }
  </style>
</head>

<body class="ln-dark">
  <!-- Top bar -->
  <header class="topbar">
    <div class="topbar-inner">
      <a href="/" class="brand" aria-label="LuminaNexus home">
        <span class="brand-title">LuminaNexus</span>
        <span class="brand-subtitle">Sanctuary · Study · Build</span>
      </a>

      <nav class="nav-links" aria-label="Main navigation">
        <a href="/about.html">About</a>
        <a href="/chavruta.html" aria-current="page">Chavruta</a>
        <a href="/library/">Library</a>
        <a href="/map.html">Map</a>
        <a href="/seal.html">Seal</a>
        <a href="/donate/index.html">Support</a>
      </nav>
    </div>
  </header>

  <main class="container ch-page">
    <!-- HERO -->
    <section class="hero-shell hero-shell--page hero-shell--chavruta" aria-labelledby="chavruta-heading">
      <div class="hero-overlay">
        <div class="hero-grid">
          <div class="stack-lg">
            <div class="text-pill">
              CHAVRUTA · <span lang="he">חַבְרוּתָא</span>
            </div>

            <h1 id="chavruta-heading" class="hero-heading">
              Study in good company.
            </h1>

            <p class="hero-subtitle">
              This is the study trunk of LuminaNexus. Here the pace is slow, the questions are honest,
              and the goal is not hot takes but clarified life.
            </p>

            <p class="hero-subtitle hero-subtitle--hebrew" lang="he">
              כָּאן לוֹמְדִים לֹא מַה שֶׁחוֹשְׁבִים שֶׁצָּרִיךְ לַעֲנוֹת, אֶלָּא מַה שֶׁהַלֵּב רוֹצֶה לְבָרֵר.
            </p>

            <div class="hero-actions">
              <a href="/" class="btn btn-primary">← Back to the Sanctuary</a>
              <a href="#table" class="btn btn-secondary">Sit at the table</a>
              <a href="#sessions" class="btn btn-ghost">View study paths</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TABLE -->
    <div class="ch-wrap">
      <section id="table" class="ch-table" aria-labelledby="table-heading">
        <div class="ch-grid">
          <!-- Left: question -->
          <div>
            <div class="ch-kicker">Your side of the table</div>
            <h2 id="table-heading" class="ch-h2">Bring one question.</h2>
            <p class="ch-sub">
              Write it slowly, as if you were speaking to a friend across the table.
              ChavrutaGPT will answer with sources and care.
            </p>

            <form class="ch-form" id="chForm">
              <label class="ch-label" for="chavruta-question">Your question</label>

              <textarea
                id="chavruta-question"
                class="ch-textarea"
                name="question"
                placeholder="For example:
• What does Rashi see in Bereshit 1:1 that I keep missing?
• How do I balance kavod and anavah with my family?
• What does it mean to keep Shabbat in my situation?"
                required
              ></textarea>

              <div class="ch-row">
                <button type="submit" class="btn btn-primary" id="askBtn">Ask →</button>
                <div class="ch-meta">
                  Enter to ask · Shift+Enter for a new line.
                </div>
              </div>

              <div class="ch-status" id="status"></div>
            </form>
          </div>

          <!-- Right: companion -->
          <aside class="ch-side">
            <div class="ch-side-title">Your chavruta will…</div>
            <ul>
              <li>Answer slowly, aiming for clarity rather than winning.</li>
              <li>Point to sources you can open yourself on Sefaria.</li>
              <li>Offer one small practice you can carry into the week.</li>
              <li>Keep the tone gentle, honest, and grounded.</li>
            </ul>
          </aside>
        </div>
      </section>

      <!-- SESSIONS: three cards -->
      <section id="sessions" class="home-section ch-sessions">
        <h2 class="section-heading">
          Sessions · <span lang="he">מַסְלוּלֵי לִמּוּד</span>
        </h2>
        <p class="section-subtitle">
          Start with whichever trunk you need most this week. Each card will grow into guided study flows.
        </p>

        <div class="card-grid">
          <article class="home-card">
            <h3>Daily Chavruta</h3>
            <p>One short source, one question, one small action — a steady daily companion.</p>
            <a href="/chavruta/daily/" class="card-link">Open daily table →</a>
          </article>

          <article class="home-card">
            <h3>Slow Series</h3>
            <p>Multi-week journeys through Shabbat, tefillah, middot, or the Seven Laws.</p>
            <a href="/chavruta/slow-series/" class="card-link">View slow journeys →</a>
          </article>

          <article class="home-card">
            <h3>Open Notes</h3>
            <p>Rough notes and questions — less polished, more laboratory, still part of the tree.</p>
            <a href="/library/open-notes/" class="card-link">Browse notes →</a>
          </article>
        </div>
      </section>
    </div>
  </main>

  <footer class="footer">
    <p class="footer-meta">&copy; 2026 LuminaNexus · Chavruta.</p>
  </footer>

  <script>
    const form = document.getElementById("chForm");
    const textarea = document.getElementById("chavruta-question");
    const askBtn = document.getElementById("askBtn");
    const statusEl = document.getElementById("status");

    function showStatus(msg) {
      statusEl.style.display = "block";
      statusEl.textContent = msg;
    }

    // Enter to send, Shift+Enter for newline
    textarea.addEventListener("keydown", (e) => {
      if (
        e.key === "Enter" &&
        !e.shiftKey &&
        !e.ctrlKey &&
        !e.altKey &&
        !e.metaKey
      ) {
        e.preventDefault();
        if (form.requestSubmit) {
          form.requestSubmit();
        } else {
          form.dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
        }
      }
    });

    function extractAnswer(payload) {
      if (!payload) return "";

      if (typeof payload === "string") return payload;
      if (typeof payload.answer === "string") return payload.answer;
      if (typeof payload.reply === "string") return payload.reply;
      if (typeof payload.content === "string") return payload.content;
      if (typeof payload.text === "string") return payload.text;
      if (typeof payload.message === "string") return payload.message;

      const c1 = payload?.choices?.[0]?.message?.content;
      if (typeof c1 === "string") return c1;

      const c2 = payload?.choices?.[0]?.text;
      if (typeof c2 === "string") return c2;

      const out = payload?.output?.[0]?.content?.[0]?.text;
      if (typeof out === "string") return out;

      try {
        return JSON.stringify(payload, null, 2);
      } catch {
        return String(payload);
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const question = (textarea.value || "").trim();
      if (question.length < 3) {
        showStatus("Please write a fuller question.");
        return;
      }

      askBtn.disabled = true;
      const old = askBtn.textContent;
      askBtn.textContent = "Thinking…";
      showStatus("Chavruta is listening…");

      try {
        const r = await fetch("/.netlify/functions/chavruta-gpt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages: [{ role: "user", content: question }]
          }),
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          const detail = data?.error || data?.detail || JSON.stringify(data) || "Request failed";
          throw new Error(detail);
        }

        const answerText = extractAnswer(data);
        if (!answerText || !answerText.trim()) {
          throw new Error("No answer returned from ChavrutaGPT.");
        }

        sessionStorage.setItem("chavruta_last_question", question);
        sessionStorage.setItem("chavruta_last_answer", answerText);

        location.href = "/chavruta/answer.html?q=" + encodeURIComponent(question);

      } catch (err) {
        showStatus("Error: " + (err?.message || err));
      } finally {
        askBtn.disabled = false;
        askBtn.textContent = old;
      }
    });
  </script>
</body>
</html>
